rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Usuarios: cada uno solo accede al suyo
    match /users/{userId} {
      // Permitir lectura y escritura si eres el propio usuario
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // ✨ Permitir que los doctores lean TODOS los usuarios (para estadísticas)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // ✨ Permitir que los cuidadores lean datos de sus pacientes (usando colección family)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver' &&
                     existsAfter(/databases/$(database)/documents/family/$(request.auth.uid + '_' + userId));
                     
      // ✨ ALTERNATIVA: Permitir que los cuidadores lean si existe un vínculo en family
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
    }

    // Recordatorios: escritura mira request.resource, lectura mira resource
    match /reminders/{reminderId} {
      allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.userId;

      allow read, update, delete: if request.auth != null
          && request.auth.uid == resource.data.userId;
      
      // ✨ Permitir que doctores y cuidadores lean recordatorios de sus pacientes
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor' ||
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver'
                     );
    }

    // Memorias: actualizado para permitir que cuidadores creen memorias para sus pacientes
    match /memories/{memoryId} {
      // Paciente puede crear sus propias memorias
      allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.userId;

      // ✨ Cuidador puede crear memorias para sus pacientes (simplificado)
      allow create: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';

      // ✨ Doctor puede crear memorias para sus pacientes (simplificado)
      allow create: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';

      // Lectura/actualización/borrado: propietario
      allow read, update, delete: if request.auth != null
          && request.auth.uid == resource.data.userId;
      
      // ✨ Permitir que doctores lean TODAS las memorias (para estadísticas)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // ✨ Permitir que cuidadores lean/editen/borren memorias de sus pacientes (simplificado)
      allow read, update, delete: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
      
      // ✨ AGREGADO: Permitir leer/editar/borrar por caregiverId o doctorId (para la galería del cuidador)
      allow read, update, delete: if request.auth != null && (
        (resource.data.caregiverId != null && resource.data.caregiverId == request.auth.uid) ||
        (resource.data.doctorId != null && resource.data.doctorId == request.auth.uid)
      );
    }
    
    // ✨ Actividades: Permitir que doctores y cuidadores lean actividades de sus pacientes
    match /activities/{activityId} {
      // El paciente puede leer/escribir sus propias actividades
      allow read, write: if request.auth != null && 
                             request.auth.uid == resource.data.patientId;
      
      // Doctores pueden leer actividades de sus pacientes (simplificado)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // Cuidadores pueden leer actividades de sus pacientes (simplificado)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
    }
    
    // ✨✨✨ NUEVO: Tests Cognitivos con IA
    match /tests/{testId} {
      // Doctores y cuidadores pueden crear tests para sus pacientes (simplificado)
      allow create: if request.auth != null && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor' ||
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver'
                       );
      
      // Paciente puede leer sus propios tests
      allow read: if request.auth != null && 
                     resource.data.patientId == request.auth.uid;
      
      // ✨ Doctores pueden leer TODOS los tests (para estadísticas y gestión)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // Cuidadores pueden leer tests de sus pacientes (simplificado)
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
      
      // Paciente puede actualizar (solo para completar el test)
      allow update: if request.auth != null && 
                       resource.data.patientId == request.auth.uid &&
                       request.resource.data.status == 'completed' &&
                       resource.data.status == 'pending';
      
      // ✨ Doctores pueden actualizar/eliminar TODOS los tests
      allow update, delete: if request.auth != null && 
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // Cuidadores pueden actualizar/eliminar tests (simplificado)
      allow update, delete: if request.auth != null && 
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
    }
    
    // ✨✨✨ NUEVO: Resultados de Tests (testResults)
    match /testResults/{resultId} {
      // Paciente puede crear sus propios resultados (cuando completa un test)
      allow create: if request.auth != null &&
                       request.resource.data.patientId == request.auth.uid;

      // Paciente puede leer sus propios resultados
      allow read: if request.auth != null &&
                     resource.data.patientId == request.auth.uid;

      // Doctores pueden leer resultados de sus pacientes (simplificado)
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // Cuidadores pueden leer resultados de sus pacientes (simplificado)
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
      
      // Doctores y cuidadores pueden actualizar/eliminar resultados (simplificado)
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
                                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor' ||
                                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver'
                               );
    }

    // ✨✨✨ NUEVO: Invitaciones para Cuidadores
    match /invitations/{invitationId} {
      // Doctores pueden crear invitaciones
      allow create: if request.auth != null &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      
      // IMPORTANTE: Permitir lectura SIN autenticación para validar tokens durante registro
      allow read: if true;
      
      // Doctor que creó la invitación puede actualizarla
      allow update: if request.auth != null &&
                       resource.data.invitedBy == request.auth.uid;
      
      // Sistema puede actualizar (cuando se acepta la invitación)
      allow update: if request.auth != null &&
                       request.resource.data.status == 'accepted';
    }

    // ✨✨✨ NUEVO: Vínculos Familia (Cuidador-Paciente-Doctor)
    match /family/{familyId} {
      // IMPORTANTE: Permitir crear vínculos sin estar autenticado (durante registro con invitación)
      allow create: if true;
      
      // Usuario puede leer si es el doctor, cuidador o paciente en el vínculo
      allow read: if request.auth != null && (
        resource.data.doctorId == request.auth.uid ||
        resource.data.caregiverId == request.auth.uid ||
        resource.data.patientId == request.auth.uid
      );
      
      // Doctores pueden actualizar/eliminar vínculos que crearon
      allow update, delete: if request.auth != null &&
                               resource.data.doctorId == request.auth.uid;
    }
  }
}